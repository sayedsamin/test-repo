// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  name            String
  email           String     @unique
  password        String
  role            Role
  profileImageUrl String?
  createdAt       DateTime   @default(now())

  tutor           Tutor?
  learnerBookings Booking[]  @relation("LearnerBookings")
  reviewsWritten  Review[]   @relation("ReviewsByLearner")
  enrolledCourses Enrollment[]
}

model Tutor {
  id              String     @id @default(auto()) @map("_id") @db.ObjectId
  user            User       @relation(fields: [userId], references: [id])
  userId          String     @unique @db.ObjectId
  bio             String
  hourlyRate      Float?
  specialties     String[]   @default([])
  availability    String?    // e.g., "weekdays", "weekends", "flexible"
  sessionDuration String?    // e.g., "30min", "1hour", "2hours"
  language        String?    @default("English")
  timezone        String?    @default("UTC-08:00 Pacific Time")
  createdAt       DateTime   @default(now())

  courses        Course[]

  bookings      Booking[]  @relation("TutorBookings")
  reviewsReceived Review[]   @relation("ReviewsForTutor")
}

model Course {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  tutor         Tutor      @relation(fields: [tutorId], references: [id])
  tutorId       String     @db.ObjectId
  title         String
  shortDescription   String
  difficulty    DifficultyLevel

  overview      String
  prerequisites String[]
  skillsLearned String[]
  totalHours    Int        // Fixed number of hours for the course

  schedule      CourseSchedule[]
  zoomLink      String?
  
  startDate     DateTime?  // Optional: Course start date
  endDate       DateTime?  // Optional: Course end date

  category      CourseCategory? @relation(fields: [categoryId], references: [id])
  categoryId    String?    @db.ObjectId
  createdAt     DateTime   @default(now())
  imageUrl      String?

  trialRate     Float
  fullCourseRate Float

  bookings      Booking[]
  enrollments   Enrollment[]
  reviews       Review[]
}

enum DifficultyLevel {
  beginner
  intermediate
  advanced
}

model CourseCategory {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String   @unique
  courses      Course[]
}


model Enrollment {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  student       User       @relation(fields: [studentId], references: [id])
  studentId     String     @db.ObjectId
  course        Course     @relation(fields: [courseId], references: [id])
  courseId      String     @db.ObjectId
  enrolledAt    DateTime   @default(now())
  completedAt   DateTime?
  hoursCompleted Int       @default(0) // Number of hours completed by tutor
  progress      Int        @default(0) // Auto-calculated: (hoursCompleted / course.totalHours) * 100

  @@unique([studentId, courseId])
}

model Booking {
  id            String     @id @default(auto()) @map("_id") @db.ObjectId
  learner       User       @relation("LearnerBookings", fields: [learnerId], references: [id])
  learnerId     String     @db.ObjectId
  tutor         Tutor      @relation("TutorBookings", fields: [tutorId], references: [id])
  tutorId       String     @db.ObjectId
  course       Course      @relation(fields: [courseId], references: [id])
  courseId     String     @db.ObjectId
  sessionDate   DateTime
  durationMin   Int
  status        BookingStatus @default(pending)
  sessionType   SessionType @default(individual)
  videoLink     String?
  createdAt     DateTime   @default(now())

  payment       Payment?
  review        Review?
}

model Payment {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  booking        Booking     @relation(fields: [bookingId], references: [id])
  bookingId      String      @unique @db.ObjectId
  amount         Float
  paymentMethod  PaymentMethod
  paymentStatus  PaymentStatus @default(pending)
  transactionId  String?
  createdAt      DateTime    @default(now())
}

model Review {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  booking        Booking   @relation(fields: [bookingId], references: [id])
  bookingId      String    @unique @db.ObjectId
  reviewer       User      @relation("ReviewsByLearner", fields: [reviewerId], references: [id])
  reviewerId     String    @db.ObjectId
  tutor          Tutor     @relation("ReviewsForTutor", fields: [tutorId], references: [id])
  tutorId        String    @db.ObjectId
  course         Course    @relation(fields: [courseId], references: [id])
  courseId       String    @db.ObjectId
  rating         Int
  comment        String?
  status         ReviewStatus @default(pending)
  createdAt      DateTime  @default(now())
  approvedAt     DateTime?
}

model ReviewRequest {
  id             String    @id @default(auto()) @map("_id") @db.ObjectId
  tutorId        String    @db.ObjectId
  courseId       String    @db.ObjectId
  studentId      String    @db.ObjectId
  message        String?
  sentAt         DateTime  @default(now())
  respondedAt    DateTime?
  status         ReviewRequestStatus @default(pending)

  @@unique([tutorId, courseId, studentId, status])
  @@index([tutorId, status])
  @@index([studentId, status])
}

type CourseSchedule {
  days      DayOfWeek[] // Multiple days for the same time slot
  startTime String      // Format: "HH:MM" (e.g., "14:30")
  endTime   String      // Format: "HH:MM" (e.g., "16:00")
  timezone  String      // Format: "America/New_York", "UTC", etc.
}

type DayAvailability {
  day       DayOfWeek
  timeSlots String[]
}

enum DayOfWeek {
  monday
  tuesday
  wednesday
  thursday
  friday
  saturday
  sunday
}

enum Role {
  tutor
  learner
}

enum BookingStatus {
  pending
  confirmed
  completed
  cancelled
}

enum PaymentMethod {
  credit_card
  paypal
  stripe
}

enum PaymentStatus {
  pending
  completed
  failed
}

enum ReviewStatus {
  pending
  accepted
  rejected
}

enum ReviewRequestStatus {
  pending
  responded
  expired
}

enum SessionType {
  individual
  group
}
